# grh: prhのGo移植版

本プロジェクトは [prh][] をGo言語で再実装するものです。

本プロジェクトの実装による挙動は極力prhに近づけたいとは考えていますが、prh自体の仕様が文書化されていないため、完全な移植版ではありません。
またprhはTypeScriptで実装されていますが、Goで実装するために正規表現の互換性がありません。そのため、prh.ymlファイルはそのままでは動作しない可能性があります。
作者の実用上の理由から本家prhにはない機能が追加されることもありえます。

[prh]: https://github.com/prh/prh/

## 主な機能

- **テキスト置換**: YAML形式のルールファイルに基づく自動テキスト置換
- **複数ファイル対応**: 複数のファイルを一度に処理
- **ルールファイル自動検索**: `prh.yml`または`prh.yaml`の自動検出
- **Hugoショートコード保護**: Hugoショートコード内のテキストを置換から保護
- **Markdown検証**: 基本的なMarkdown構文の検証
- **多様な出力形式**: 標準出力、差分表示、ファイル上書きに対応
- **包括的なテスト**: 単体テスト、統合テスト、CLIテストを完備

## プロジェクトの構成

* ルートディレクトリ: github.com/ymotongpoo/grh をライブラリとして実装するパッケージ
* cmd: github.com/ymotongpoo/grh をインポートし、grhコマンドを実装するためのパッケージ
* testdata/yaml: テスト用のルール定義ファイルが置いてあるディレクトリ
* testdata/doc: テスト用のドキュメントが置いてあるディレクトリ

## grhコマンドの仕様

grhの基本的な機能は、YAML形式で表現されたルールに基づいて、与えられたファイル内の文章を置換します。

```
grh 対象ファイル [対象ファイル...]
```

複数ファイルを指定すると、ファイルそれぞれに対してルールを適用します。
ルールファイルは指定がない場合は、コマンドを実行した際のカレントディレクトリおよびその親ディレクトリを辿っていって見つかった `prh.yml` もしくは `prh.yaml` ファイルを読み込みます。

grhコマンドは次のようなオプションを受け付けます。

* --rules-yaml: 読み込んだルールを標準出力にYAML形式で表示する。出力用のYAMLの仕様は後述する。
* --rules-json: 読み込んだルールを標準出力にJSON形式で表示する。出力用のJSONのスキーマは `--rules-yaml` と同じ。
* --rules: grhコマンドを実行する際のルールファイルを指定する。この場合デフォルトのルールファイルの読み込み規則は適用しない。
* --verify: 指定したファイルがMarkdownとして正しいか確認する。ただし [Hugo][] の各種ショートコードは認める。
* --stdout: 指定したファイルをルールファイルに基づいて置換した結果を標準出力に表示する
* --diff: 指定したファイルとそれをルールファイルに基づいて置換した結果を[Unified diff][]形式で出力する
* -r, --replace: 指定したファイルをルールファイルに基づいて置換し上書きする

[Hugo]: https://gohugo.io/
[Unified diff]: https://www.gnu.org/software/diffutils/manual/html_node/Detailed-Unified.html

## ルールファイルの仕様

ルールは次のYAMLスキーマを用いて設定します。
各フィールドの説明は [grh.yaml](grh.yaml) を参照してください。そのファイル内のコメントに詳細な解説があります。

## --rules-yaml、--rules-json用の仕様

`--rules-yaml` や `--rules-json` で表示する仕様はルールファイルと同じですが、複数のルールファイルを読み込んだあとの最終結果を表示します。
複数のルールファイルを読み込んだ場合、最後に読み込まれたルールが優先されます。

また上のルールファイルの仕様に加えて、以下のフィールドが追加されています。

- `sourcePaths`: 読み込んだルールファイルのパスの配列。複数ある場合はすべて列挙します。

## Hugoショートコード対応

grhはHugoの静的サイトジェネレーターで使用されるショートコードを認識し、ショートコード内のテキストを置換から保護します。

対応しているショートコード形式：
- ペアードショートコード: `{{< name >}}...{{< /name >}}`
- ペアードショートコード（代替形式）: `{{% name %}}...{{% /name %}}`
- セルフクローズショートコード: `{{< name >}}`、`{{< name />}}`
- セルフクローズショートコード（代替形式）: `{{% name %}}`、`{{% name /%}}`

## 使用例

### 基本的な使用方法

```bash
# カレントディレクトリのprh.ymlを使用してファイルを処理
grh document.md

# 特定のルールファイルを指定
grh --rules custom-rules.yml document.md

# 複数ファイルを一度に処理
grh *.md

# 結果を標準出力に表示（ファイルは変更しない）
grh --stdout document.md

# 差分を表示
grh --diff document.md

# ファイルを上書き
grh --replace document.md
```

### ルール確認

```bash
# 読み込まれるルールをYAML形式で確認
grh --rules-yaml

# 読み込まれるルールをJSON形式で確認
grh --rules-json
```

### Markdown検証

```bash
# Markdownファイルの構文を検証
grh --verify document.md
```

## テスト

```bash
# 全テストを実行
go test

# 特定のテストを実行
go test -run TestIntegration

# 詳細なテスト出力
go test -v
```

## ビルド

```bash
# grhコマンドをビルド
go build -o grh ./cmd/grh

# インストール
go install ./cmd/grh
```

